<!DOCTYPE html>
<html lang="-m">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Управление тегами — Админ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">Журнал UZ</a>
      <div class="navbar-nav ms-auto">
        <a href="admin.html" class="btn btn-outline-light me-3">← Админ-панель</a>
        <button class="btn btn-outline-light" id="logoutBtn">Выйти</button>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="card shadow">
          <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
            <h3 class="mb-0">Управление тегами</h3>
            <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addTagModal">
              <i class="fas fa-plus me-2"></i>Добавить тег
            </button>
          </div>
          <div class="card-body">
            <div id="tagsList" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
            <div id="noTags" class="text-center text-muted py-5 d-none">
              <i class="fas fa-tags fa-3x mb-3"></i>
              <p>Тегов пока нет. Добавьте первый!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления тега -->
  <div class="modal fade" id="addTagModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Новый тег</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Название тега</label>
            <input type="text" class="form-control" id="newTagName" placeholder="например: квантовая физика" autofocus>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="saveTagBtn">
            <i class="fas fa-save me-2"></i>Добавить
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { supabaseUrl, supabaseKey } from './supabase-config.js';

    const supabase = createClient(supabaseUrl, supabaseKey);

    async function checkAdmin() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', session.user.id)
        .single();

      if (!profile || profile.role !== 'admin') {
        alert('Доступ запрещён! Только для администратора.');
        window.location.href = 'dashboard.html';
        return;
      }

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      loadTags();
    }

    async function loadTags() {
      const { data: tags, error } = await supabase
        .from('tags')
        .select('*')
        .order('name');

      if (error) {
        console.error(error);
        document.getElementById('tagsList').innerHTML = '<p class="text-danger col-12">Ошибка загрузки тегов</p>';
        return;
      }

      const list = document.getElementById('tagsList');
      const noTags = document.getElementById('noTags');

      if (!tags || tags.length === 0) {
        list.innerHTML = '';
        noTags.classList.remove('d-none');
        return;
      }

      noTags.classList.add('d-none');
      list.innerHTML = tags.map(tag => `
        <div class="col">
          <div class="card h-100 text-center shadow-sm hover-shadow">
            <div class="card-body d-flex flex-column justify-content-between">
              <div>
                <i class="fas fa-tag text-primary mb-2" style="font-size: 2rem;"></i>
                <h6 class="card-title mb-2">${tag.name}</h6>
              </div>
              <button class="btn btn-danger btn-sm mt-3" onclick="deleteTag('${tag.id}', '${tag.name}')">
                <i class="fas fa-trash"></i> Удалить
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Добавление тега (теперь работает!)
    document.getElementById('saveTagBtn').addEventListener('click', async () => {
      const nameInput = document.getElementById('newTagName');
      const name = nameInput.value.trim();

      if (!name) {
        alert('Введите название тега');
        return;
      }

      const { error } = await supabase
        .from('tags')
        .insert({ name });

      if (error) {
        if (error.code === '23505') {
          alert('Тег с таким названием уже существует');
        } else {
          alert('Ошибка: ' + error.message);
        }
      } else {
        nameInput.value = '';
        bootstrap.Modal.getInstance(document.getElementById('addTagModal')).hide();
        loadTags();
      }
    });

    // Удаление тега
    window.deleteTag = async (id, name) => {
      if (!confirm(`Удалить тег "${name}"?\nЭто удалит его из всех статей!`)) return;

      const { error } = await supabase
        .from('tags')
        .delete()
        .eq('id', id);

      if (error) {
        alert('Ошибка удаления: ' + error.message);
      } else {
        loadTags();
      }
    };

    checkAdmin();
  </script>
</body>
</html>
