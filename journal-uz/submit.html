<!-- ... head и nav как раньше ... -->

<div class="container mt-5">
  <div class="card">
    <div class="card-header"><h3>Подача статьи</h3></div>
    <div class="card-body">
      <form id="submitForm">
        <!-- Название, авторы, аннотация, файл — как раньше -->

        <!-- ТЕГИ: Кнопка "Добавить теги" -->
        <div class="mb-3">
          <label class="form-label">Теги</label>
          <div id="selectedTags" class="d-flex flex-wrap gap-2 mb-2"></div>
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#tagsModal">
            <span id="tagButtonText">Добавить теги</span>
          </button>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">Отправить статью</button>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно с тегами -->
<div class="modal fade" id="tagsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Выберите теги</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="allTags" class="d-flex flex-wrap gap-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Готово</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ... checkSession как раньше ...

  let selectedTagIds = [];

  async function loadAllTags() {
    const { data } = await supabase.from('tags').select('id, name').order('name');
    const container = document.getElementById('allTags');
    container.innerHTML = data.map(tag => `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="${tag.id}" id="tag-${tag.id}">
        <label class="form-check-label" for="tag-${tag.id}">${tag.name}</label>
      </div>
    `).join('');

    // Восстанавливаем выбранные
    document.querySelectorAll('#alluckTags input').forEach(cb => {
      cb.checked = selectedTagIds.includes(cb.value);
      cb.addEventListener('change', () => {
        if (cb.checked) {
          selectedTagIds.push(cb.value);
        } else {
          selectedTagIds = selectedTagIds.filter(id => id !== cb.value);
        }
        updateSelectedTags();
      });
    });
  }

  function updateSelectedTags() {
    const container = document.getElementById('selectedTags');
    if (selectedTagIds.length === 0) {
      container.innerHTML = '<small class="text-muted">Теги не выбраны</small>';
      document.getElementById('tagButtonText').textContent = 'Добавить теги';
    } else {
      container.innerHTML = selectedTagIds.map(id => {
        const tag = document.querySelector(`#tag-${id} + label`).textContent;
        return `<span class="badge bg-primary">${tag} <i class="fas fa-times ms-1 cursor-pointer" onclick="removeTag('${id}')"></i></span>`;
      }).join(' ');
      document.getElementById('tagButtonText').textContent = 'Изменить теги';
    }
  }

  window.removeTag = (id) => {
    selectedTagIds = selectedTagIds.filter(t => t !== id);
    document.getElementById(`tag-${id}`).checked = false;
    updateSelectedTags();
  };

  // При открытии модалки — загружаем теги
  document.getElementById('tagsModal').addEventListener('show.bs.modal', loadAllTags);

  // В submitForm — после создания статьи
  document.getElementById('submitForm').addEventListener('submit', async (e) => {
    // ... весь код загрузки файла и создания submission как раньше ...

    if (selectedTagIds.length > 0) {
      const links = selectedTagIds.map(tag_id => ({
        submission_id: submission.id,
        tag_id
      }));
      await supabase.from('submission_tags').insert(links);
    }

    alert('Статья подана!');
    window.location.href = 'dashboard.html';
  });
</script>
