<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Профиль — Журнал UZ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Журнал UZ</a>
      <button class="btn btn-outline-light" id="logoutBtn">Выйти</button>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="card mx-auto shadow-lg" style="max-width: 500px; border-radius: 20px;">
      <div class="card-body p-5 text-center">
        <i class="fas fa-user-edit fa-4x text-primary mb-4"></i>
        <h3 class="fw-bold">Завершите регистрацию</h3>
        <p class="text-muted">Введите ваше полное имя для публикаций</p>

        <form id="profileForm" class="mt-4">
          <div class="mb-4">
            <input type="text" class="form-control form-control-lg text-center" id="fullName" placeholder="Иванов Иван Иванович" required>
          </div>
          <button type="submit" class="btn btn-primary btn-lg w-100">
            Сохранить и продолжить
          </button>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { supabaseUrl, supabaseKey } from './supabase-config.js';

    const supabase = createClient(supabaseUrl, supabaseKey);

    document.getElementById('logoutBtn').onclick = () => supabase.auth.signOut().then(() => location.href = 'login.html');

    // Проверка сессии и профиля
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) location.href = 'login.html';

    const { data: profile } = await supabase
      .from('profiles')
      .select('full_name')
      .eq('id', session.user.id)
      .single();

    // Если имя уже есть — сразу на главную
    if (profile?.full_name) {
      location.href = 'index.html';
      return;
    }

    // Если нет — показываем форму
    document.getElementById('profileForm').onsubmit = async (e) => {
      e.preventDefault();
      const fullName = document.getElementById('fullName').value.trim();
      if (!fullName) return alert('Введите имя!');

      const { error } = await supabase
        .from('profiles')
        .update({ full_name: fullName, updated_at: new Date().toISOString() })
        .eq('id', session.user.id);

      if (error) alert('Ошибка: ' + error.message);
      else {
        alert('Добро пожаловать, ' + fullName.split(' ')[1] + '!');
        location.href = 'index.html';
      }
    };
  </script>
</body>
</html>
