<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Журнал UZ — Научный журнал Узбекистана</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="index-page">

  <section class="py-5 text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container py-5">
      <div class="row">
        <div class="col-lg-9">
          <h1 class="display-3 fw-bold text-white mb-3">Журнал UZ</h1>
          <p class="lead fs-3 text-white mb-3">Научный рецензируемый журнал Узбекистана</p>
          <p class="fs-5 text-white opacity-90">
            Публикация оригинальных научных статей • Открытый доступ • Двойное слепое рецензирование
          </p>
        </div>
      </div>
    </div>
  </section>

  <div class="container my-5">
    <div class="row mb-5">
      <div class="col-md-8 mx-auto">
        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
          <span class="input-group-text bg-white border-0">Search</span>
          <input type="text" id="searchInput" class="form-control border-0 shadow-0" placeholder="Поиск по названию, автору или тегу...">
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-3 mb-5">
        <h5 class="fw-bold mb-4">Направления науки</h5>
        <div id="tagsCloud" class="bg-light p-4 rounded-3 shadow-sm">
          <div class="text-center text-muted">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <small class="d-block mt-2">Загрузка...</small>
          </div>
        </div>
      </div>

      <div class="col-lg-9">
        <h3 class="fw-bold mb-4">Опубликованные статьи</h3>
        <div id="articlesList" class="row g-4"></div>
        <div id="noResults" class="text-center py-5 d-none">
          <i class="fas fa-book-open fa-4x text-muted mb-4 opacity-50"></i>
          <h4 class="text-muted">Статьи не найдены</h4>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  import { supabaseUrl, supabaseKey } from './supabase-config.js';

  const supabase = createClient(supabaseUrl, supabaseKey);

  window.goToTag = (tag) => {
    window.location.href = `tag.html?tag=${encodeURIComponent(tag)}`;
  };

  async function loadTags() {
    const { data: tags, error } = await supabase
      .from('tags')
      .select('id, name, category')  // ← ЯВНО указываем id
      .order('category')
      .order('name');

    const cloud = document.getElementById('tagsCloud');

    if (error) {
      cloud.innerHTML = `<p class="text-danger text-center">Ошибка: ${error.message}</p>`;
      console.error(error);
      return;
    }

    if (!tags || tags.length === 0) {
      cloud.innerHTML = '<p class="text-muted text-center">Теги не найдены</p>';
      return;
    }

    const categories = {};
    tags.forEach(t => {
      if (!categories[t.category]) categories[t.category] = [];
      categories[t.category].push(t.name);
    });

    cloud.innerHTML = Object.keys(categories).map(cat => `
      <div class="mb-4">
        <h6 class="fw-bold text-primary mb-3">${cat}</h6>
        <div class="d-flex flex-wrap gap-2">
          ${categories[cat].map(name => `
            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 py-2" onclick="goToTag('${name}')">
              ${name}
            </button>
          `).join('')}
        </div>
      </div>
    `).join('');
  }

  // Остальной код loadArticles() остаётся тот же — только добавь .select('id, ...') везде, где есть tags
  async function loadArticles(query = '') {
    let sql = supabase.from('submissions')
      .select('id, title, authors, abstract, file_url, views, submitted_at')
      .eq('status', 'Опубликована')
      .order('submitted_at', { ascending: false });

    if (query) {
      const q = query.toLowerCase();
      sql = sql.or(`title.ilike.%${q}%, authors.ilike.%${q}%, abstract.ilike.%${q}%`);
    }

    const { data: articles } = await sql;
    const container = document.getElementById('articlesList');
    const noResults = document.getElementById('noResults');

    if (!articles || articles.length === 0) {
      container.innerHTML = '';
      noResults.classList.remove('d-none');
      return;
    }

    noResults.classList.add('d-none');

    // ← ИСПРАВЛЕНИЕ: явно запрашиваем id у тегов
    const { data: links } = await supabase.from('submission_tags').select('submission_id, tag_id');
    const { data: allTags } = await supabase.from('tags').select('id, name');

    const tagMap = {};
    links?.forEach(l => {
      if (!tagMap[l.submission_id]) tagMap[l.submission_id] = [];
      const tag = allTags?.find(t => t.id === l.tag_id);
      if (tag) tagMap[l.submission_id].push(tag.name);
    });

    container.innerHTML = articles.map(a => {
      const articleTags = (tagMap[a.id] || []).map(t => 
        `<a href="tag.html?tag=${encodeURIComponent(t)}" class="badge bg-primary text-decoration-none me-1">${t}</a>`
      ).join('');

      return `
        <div class="col-12 mb-4">
          <div class="card h-100 shadow-sm border-0 hover-shadow">
            <div class="card-body">
              <h5 class="card-title fw-bold">
                <a href="article.html?id=${a.id}" class="text-primary text-decoration-none stretched-link">
                  ${a.title}
                </a>
              </h5>
              <p class="text-muted mb-2"><strong>Авторы:</strong> ${a.authors}</p>
              <p class="card-text text-muted">${a.abstract.substring(0, 250)}...</p>
              ${articleTags ? `<div class="mb-3">${articleTags}</div>` : ''}
              <div class="d-flex justify-content-between align-items-center mt-4">
                <small class="text-muted">
                  ${new Date(a.submitted_at).toLocaleDateString('ru')}
                  <span class="ms-3">${a.views || 0} просмотров</span>
                </small>
                <a href="article.html?id=${a.id}" class="btn btn-outline-primary btn-sm">
                  Читать полностью
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  document.getElementById('searchInput').addEventListener('input', e => {
    loadArticles(e.target.value.trim());
  });

  loadTags();
  loadArticles();
</script>

  <style>
    .hover-shadow { transition: all 0.3s ease; }
    .hover-shadow:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.12) !important; }
  </style>
</body>
</html>

