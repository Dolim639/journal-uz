<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">Журнал UZ</a>
      <div class="navbar-nav ms-auto">
        <button class="btn btn-outline-light" id="logoutBtn" style="display: none;">Выйти</button>
      </div>
    </div>
  </nav>
  <div class="container mt-5">
    <h2>Управление пользователями</h2>
    <div id="usersList" class="row"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { supabaseUrl, supabaseKey } from './supabase-config.js';

    const supabase = createClient(supabaseUrl, supabaseKey);
    console.log('Supabase готов!');

    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      // Проверка роли admin
      const { data: userData } = await supabase.from('users').select('role').eq('id', session.user.id).single();
      if (!userData || userData.role !== 'admin') {
        alert('Доступ запрещён — только для админов');
        window.location.href = 'dashboard.html';
        return;
      }
      document.getElementById('logoutBtn').style.display = 'block';
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });
      loadUsers();
    }

    async function loadUsers() {
      try {
        const { data: users, error } = await supabase.from('users').select('*');
        if (error) throw error;

        const list = document.getElementById('usersList');
        list.innerHTML = '';

        users.forEach((user) => {
          const card = `
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body">
                  <h5>${user.name} (${user.email})</h5>
                  <p>Роль: <select id="role-${user.id}" class="form-select">
                    <option value="author" ${user.role === 'author' ? 'selected' : ''}>Author</option>
                    <option value="reviewer" ${user.role === 'reviewer' ? 'selected' : ''}>Reviewer</option>
                    <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select></p>
                  <button class="btn btn-primary" onclick="updateRole('${user.id}')">Сохранить роль</button>
                </div>
              </div>
            </div>
          `;
          list.innerHTML += card;
        });
      } catch (error) {
        console.error(error);
        document.getElementById('usersList').innerHTML = '<p>Ошибка загрузки пользователей</p>';
      }
    }

    window.updateRole = async (userId) => {
      const newRole = document.getElementById(`role-${userId}`).value;
      const { error } = await supabase.from('users').update({ role: newRole }).eq('id', userId);
      if (error) alert('Ошибка: ' + error.message);
      else alert('Роль обновлена!');
      loadUsers();  // Перезагрузка списка
    };

    checkSession();
  </script>
</body>
</html>
